{% extends "base.html" %}

{% block content %}
<h2>使用宁波大学统一身份认证登录</h2>

<div class="login-tabs">
    <button type="button" class="tab-btn active" onclick="switchLoginTab('password')">密码登录</button>
    <button type="button" class="tab-btn" onclick="switchLoginTab('qrcode')">扫码登录</button>
</div>

<div id="password-login" class="login-tab-content active">
    <p>请输入您的宁波大学学号和密码进行登录。</p>
    <form method="POST" action="{{ url_for('login') }}">
        <input type="hidden" name="login_type" value="password">
        <div class="form-group">
            <label for="username">学号 (Username):</label>
            <input type="text" id="username" name="username" required placeholder="输入您的学号">
        </div>
        <div class="form-group">
            <label for="password">密码 (Password):</label>
            <input type="password" id="password" name="password" required placeholder="输入您的密码">
        </div>
        <button type="submit" class="btn">登录</button>
    </form>
</div>

<div id="qrcode-login" class="login-tab-content">
    <div class="qrcode-container">
	<br>
        <div id="qrcode-display" onclick="handleQRCodeClick()">
            <div class="qrcode-placeholder">正在加载二维码...</div>
            <div id="qrcode-status" class="qrcode-status"></div>
        </div>
    </div>
    <p class="qrcode-prompt">请使用风华宁大App扫描二维码</p>
</div>

<script>
let qrcode_uuid = null;
let qrcode_polling_interval = null;
let qrcode_execution = null;
let qrcode_timeout_timer = null;
let is_qrcode_loading = false;
let is_timed_out = false;


function switchLoginTab(tabName) {
    // 移除所有活动状态
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.login-tab-content').forEach(content => content.classList.remove('active'));
    
    // 激活选中的标签
    event.target.classList.add('active');
    document.getElementById(tabName + '-login').classList.add('active');
    
    // 如果切换到二维码登录，自动获取二维码
    if (tabName === 'qrcode') {
        getQRCode();
    } else {
        stopQRCodePolling();
    }
}

function getQRCode() {
    if (is_qrcode_loading) return; // 防止重复点击
    is_qrcode_loading = true;
    is_timed_out = false; // 重置超时标志

    const statusDiv = document.getElementById('qrcode-status');
    const qrcodeDisplay = document.getElementById('qrcode-display');
    
    // 重置状态
    qrcodeDisplay.className = 'loading';
    qrcodeDisplay.innerHTML = '<div class="qrcode-placeholder"><span class="loading-spinner"></span></div><div id="qrcode-status" class="qrcode-status"></div>';
    
    fetch('/get_qrcode', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            qrcode_uuid = data.uuid;
            qrcode_execution = data.execution;

            // 显示二维码
            qrcodeDisplay.innerHTML = `<img src="data:image/png;base64,${data.qrcode_image}" alt="二维码"><div id="qrcode-status" class="qrcode-status"></div>`;
            qrcodeDisplay.className = 'waiting';
            // "等待扫描" 状态不显示任何文本
            document.getElementById('qrcode-status').textContent = '';

            // 开始轮询状态
            startQRCodePolling();
            
        } else {
            qrcodeDisplay.className = 'error';
            document.getElementById('qrcode-status').textContent = '获取失败: ' + data.error;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        qrcodeDisplay.className = 'error';
        document.getElementById('qrcode-status').textContent = '网络错误';
    })
    .finally(() => {
        is_qrcode_loading = false;
    });
}

function handleQRCodeClick() {
    // 仅当二维码超时或加载失败时，点击才有效
    const qrcodeDisplay = document.getElementById('qrcode-display');
    if (qrcodeDisplay.classList.contains('timed-out') || qrcodeDisplay.classList.contains('error')) {
        getQRCode();
    }
}


function startQRCodePolling() {
    if (!qrcode_uuid) return;
    
    // 清除旧的定时器
    stopQRCodePolling();

    qrcode_polling_interval = setInterval(() => {
        checkQRCodeStatus();
    }, 1500); // 每1.5秒检查一次
    
    // 设置2分钟超时
    qrcode_timeout_timer = setTimeout(() => {
        if (qrcode_polling_interval) {
            is_timed_out = true; // 设置超时标志
            stopQRCodePolling();
            const qrcodeDisplay = document.getElementById('qrcode-display');
            const statusDiv = document.getElementById('qrcode-status');
            qrcodeDisplay.className = 'timed-out';
            statusDiv.innerHTML = `
                <div class="scan-timeout-icon">↻</div>
                <div class="scan-timeout-text-main">二维码失效</div>
                <div class="scan-timeout-text-sub">点击刷新</div>
            `;
        }
    }, 120000);
}

function stopQRCodePolling() {
    if (qrcode_polling_interval) {
        clearInterval(qrcode_polling_interval);
        qrcode_polling_interval = null;
    }
    if (qrcode_timeout_timer) {
        clearTimeout(qrcode_timeout_timer);
        qrcode_timeout_timer = null;
    }
}

function checkQRCodeStatus() {
    if (!qrcode_uuid) return;
    
    fetch('/check_qrcode_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            uuid: qrcode_uuid
        })
    })
    .then(response => response.json())
    .then(data => {
        // 如果已经超时，则不处理后续的服务器响应
        if (is_timed_out) {
            return;
        }

        const statusDiv = document.getElementById('qrcode-status');
        const qrcodeDisplay = document.getElementById('qrcode-display');
        
        if (data.success) {
            if (data.status === '0') {
                qrcodeDisplay.className = 'waiting';
                statusDiv.innerHTML = ''; // 确保为空
            } else if (data.status === '2') {
                qrcodeDisplay.className = 'scanned';
                statusDiv.innerHTML = `
                    <div class="scan-success-icon">✓</div>
                    <div class="scan-success-text-main">扫码成功</div>
                    <div class="scan-success-text-sub">请在手机上确认</div>
                `;
            } else {
                // 登录成功，不再显示UI，直接提交
                stopQRCodePolling();
                submitQRCodeLogin();
            }
        } else {
            console.error('检查状态失败:', data.error);
        }
    })
    .catch(error => {
        console.error('Error checking status:', error);
    });
}

function submitQRCodeLogin() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("login") }}';
    
    const loginTypeInput = document.createElement('input');
    loginTypeInput.type = 'hidden';
    loginTypeInput.name = 'login_type';
    loginTypeInput.value = 'qrcode';
    form.appendChild(loginTypeInput);
    
    const uuidInput = document.createElement('input');
    uuidInput.type = 'hidden';
    uuidInput.name = 'uuid';
    uuidInput.value = qrcode_uuid;
    form.appendChild(uuidInput);
    
    const executionInput = document.createElement('input');
    executionInput.type = 'hidden';
    executionInput.name = 'execution';
    executionInput.value = qrcode_execution;
    form.appendChild(executionInput);
    
    document.body.appendChild(form);
    form.submit();
}

// 页面卸载时停止轮询
window.addEventListener('beforeunload', function() {
    stopQRCodePolling();
});

// 初始化时，如果二维码tab是激活的，则获取二维码
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('qrcode-login').classList.contains('active')) {
        getQRCode();
    }
});

</script>
{% endblock %}