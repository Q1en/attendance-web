{% extends "base.html" %}

{% block content %}
<h2>使用宁波大学统一身份认证登录</h2>

<!-- 登录方式选择标签 -->
<div class="login-tabs">
    <button type="button" class="tab-btn active" onclick="switchLoginTab('password')">密码登录</button>
    <button type="button" class="tab-btn" onclick="switchLoginTab('qrcode')">扫码登录</button>
</div>

<!-- 密码登录表单 -->
<div id="password-login" class="login-tab-content active">
    <p>请输入您的宁波大学学号和密码进行登录。</p>
    <form method="POST" action="{{ url_for('login') }}">
        <input type="hidden" name="login_type" value="password">
        <div class="form-group">
            <label for="username">学号 (Username):</label>
            <input type="text" id="username" name="username" required placeholder="输入您的学号">
        </div>
        <div class="form-group">
            <label for="password">密码 (Password):</label>
            <input type="password" id="password" name="password" required placeholder="输入您的密码">
        </div>
        <button type="submit" class="btn">登录</button>
    </form>
</div>

<!-- 二维码登录界面 -->
<div id="qrcode-login" class="login-tab-content">
    <p>请使用风华宁大App扫描下方二维码进行登录。</p>
    <div class="qrcode-container">
        <div id="qrcode-display">
            <div class="qrcode-placeholder">点击"获取二维码"开始扫码登录</div>
        </div>
        <div class="qrcode-controls">
            <button type="button" id="get-qrcode-btn" class="btn" onclick="getQRCode()">获取二维码</button>
            <button type="button" id="refresh-qrcode-btn" class="btn" onclick="refreshQRCode()" style="display:none;">刷新二维码</button>
        </div>
        <div id="qrcode-status" class="qrcode-status"></div>
    </div>
</div>

<script>
let qrcode_uuid = null;
let qrcode_polling_interval = null;
let qrcode_execution = null;

function switchLoginTab(tabName) {
    // 移除所有活动状态
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.login-tab-content').forEach(content => content.classList.remove('active'));
    
    // 激活选中的标签
    event.target.classList.add('active');
    document.getElementById(tabName + '-login').classList.add('active');
    
    // 如果切换到密码登录，停止二维码轮询
    if (tabName === 'password') {
        stopQRCodePolling();
    }
}

function getQRCode() {
    const btn = document.getElementById('get-qrcode-btn');
    const statusDiv = document.getElementById('qrcode-status');
    const qrcodeDisplay = document.getElementById('qrcode-display');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span>获取中...';
    statusDiv.textContent = '';
    qrcodeDisplay.innerHTML = '<div class="qrcode-placeholder">正在获取二维码...</div>';
    
    fetch('/get_qrcode', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            qrcode_uuid = data.uuid;
            qrcode_execution = data.execution;
            
            // 显示二维码
            qrcodeDisplay.innerHTML = `<img src="data:image/png;base64,${data.qrcode_image}" alt="二维码">`;
            
            // 显示状态
            statusDiv.className = 'qrcode-status waiting';
            statusDiv.textContent = '请使用风华宁大App扫描二维码';
            
            // 显示刷新按钮
            document.getElementById('refresh-qrcode-btn').style.display = 'inline-block';
            
            // 开始轮询状态
            startQRCodePolling();
            
        } else {
            statusDiv.className = 'qrcode-status error';
            statusDiv.textContent = '获取二维码失败: ' + data.error;
            qrcodeDisplay.innerHTML = '<div class="qrcode-placeholder">获取二维码失败</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.className = 'qrcode-status error';
        statusDiv.textContent = '网络错误，请重试';
        qrcodeDisplay.innerHTML = '<div class="qrcode-placeholder">网络错误</div>';
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '获取二维码';
    });
}

function refreshQRCode() {
    stopQRCodePolling();
    getQRCode();
}

function startQRCodePolling() {
    if (!qrcode_uuid) return;
    
    qrcode_polling_interval = setInterval(() => {
        checkQRCodeStatus();
    }, 2000); // 每2秒检查一次
    
    // 设置2分钟超时
    setTimeout(() => {
        if (qrcode_polling_interval) {
            stopQRCodePolling();
            document.getElementById('qrcode-status').className = 'qrcode-status error';
            document.getElementById('qrcode-status').textContent = '二维码已超时，请重新获取';
        }
    }, 120000);
}

function stopQRCodePolling() {
    if (qrcode_polling_interval) {
        clearInterval(qrcode_polling_interval);
        qrcode_polling_interval = null;
    }
}

function checkQRCodeStatus() {
    if (!qrcode_uuid) return;
    
    fetch('/check_qrcode_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            uuid: qrcode_uuid
        })
    })
    .then(response => response.json())
    .then(data => {
        const statusDiv = document.getElementById('qrcode-status');
        
        if (data.success) {
            if (data.status === '0') {
                statusDiv.className = 'qrcode-status waiting';
                statusDiv.textContent = '等待扫描...';
            } else if (data.status === '2') {
                statusDiv.className = 'qrcode-status scanned';
                statusDiv.textContent = '已扫描，请在手机上确认登录';
            } else {
                // 登录成功，提交登录
                statusDiv.className = 'qrcode-status success';
                statusDiv.textContent = '登录确认成功，正在跳转...';
                stopQRCodePolling();
                submitQRCodeLogin();
            }
        } else {
            console.error('检查状态失败:', data.error);
        }
    })
    .catch(error => {
        console.error('Error checking status:', error);
    });
}

function submitQRCodeLogin() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("login") }}';
    
    const loginTypeInput = document.createElement('input');
    loginTypeInput.type = 'hidden';
    loginTypeInput.name = 'login_type';
    loginTypeInput.value = 'qrcode';
    form.appendChild(loginTypeInput);
    
    const uuidInput = document.createElement('input');
    uuidInput.type = 'hidden';
    uuidInput.name = 'uuid';
    uuidInput.value = qrcode_uuid;
    form.appendChild(uuidInput);
    
    const executionInput = document.createElement('input');
    executionInput.type = 'hidden';
    executionInput.name = 'execution';
    executionInput.value = qrcode_execution;
    form.appendChild(executionInput);
    
    document.body.appendChild(form);
    form.submit();
}

// 页面卸载时停止轮询
window.addEventListener('beforeunload', function() {
    stopQRCodePolling();
});
</script>
{% endblock %}